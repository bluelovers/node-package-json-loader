{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["import fs = require('fs-extra');\nimport PACKAGE_JSON = require('./package.json');\nimport { sortPackageJson } from 'sort-package-json';\nimport pkgUp = require('pkg-up');\nimport bind from 'bind-decorator';\nimport { fixBinPath } from './util';\nimport path = require('path');\n\nexport class PackageJsonLoader<T = IPackageJson>\n{\n\treadonly file: string;\n\tprotected json;\n\tloaded: boolean;\n\n\t@bind\n\tstatic create<T = IPackageJson>(file: string, ...argv)\n\t{\n\t\treturn new this<T>(file, ...argv)\n\t}\n\n\tstatic findPackageJsonPath(name: string): string\n\t{\n\t\treturn pkgUp.sync({\n\t\t\tcwd: require.resolve(name),\n\t\t});\n\t}\n\n\t@bind\n\tstatic loadByModuleName<T = IPackageJson>(name: string)\n\t{\n\t\tlet file = this.findPackageJsonPath(name)\n\n\t\tlet pkg = this.create<T>(file);\n\n\t\tif (pkg.data.name !== name)\n\t\t{\n\t\t\tthrow new TypeError(`package name not match, '${pkg.data.name}' != '${name}'`);\n\t\t}\n\n\t\treturn pkg;\n\t}\n\n\tconstructor(file: string, ...argv)\n\t{\n\t\tthis.file = file;\n\t}\n\n\tget dir()\n\t{\n\t\treturn path.dirname(this.file)\n\t}\n\n\tset data(json)\n\t{\n\t\tthis.overwrite(json);\n\t}\n\n\tget data(): IPackageJson\n\t{\n\t\tif (!this.loaded && this.file)\n\t\t{\n\t\t\tthis.read();\n\t\t}\n\n\t\treturn this.json;\n\t}\n\n\toverwrite(json)\n\t{\n\t\tthis.loaded = true;\n\t\tthis.json = json;\n\n\t\treturn this;\n\t}\n\n\tautofix()\n\t{\n\t\tlet self = this;\n\t\tlet dir: string;\n\n\t\tif (self.file && fs.existsSync(dir = self.dir))\n\t\t{\n\t\t\tif (self.data)\n\t\t\t{\n\t\t\t\tif (self.data.bin)\n\t\t\t\t{\n\t\t\t\t\tif (typeof self.data.bin === 'string')\n\t\t\t\t\t{\n\t\t\t\t\t\tlet bin_new = fixBinPath(self.data.bin, dir);\n\n\t\t\t\t\t\tif (bin_new)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.data.bin = bin_new;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof self.data.bin === 'object' && !Array.isArray(self.data.bin))\n\t\t\t\t\t{\n\t\t\t\t\t\tObject.keys(self.data.bin)\n\t\t\t\t\t\t\t.forEach(function (key)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (typeof self.data.bin[key] === 'string')\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlet bin_new = fixBinPath(self.data.bin[key], dir);\n\n\t\t\t\t\t\t\t\t\tif (bin_new)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tself.data.bin[key] = bin_new;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!self.data.publishConfig\n\t\t\t\t\t&& self.data.name\n\t\t\t\t\t&& /\\//.test(self.data.name)\n\t\t\t\t\t&& !self.data.private\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tself.data.publishConfig = {\n\t\t\t\t\t\taccess: \"public\",\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\texists()\n\t{\n\t\treturn fs.existsSync(this.file)\n\t}\n\n\tread()\n\t{\n\t\tthis.loaded = true;\n\t\tthis.json = fs.readJSONSync(this.file);\n\n\t\treturn this;\n\t}\n\n\tstringify()\n\t{\n\t\treturn JSON.stringify(this.json, null, 2)\n\t}\n\n\tsort()\n\t{\n\t\tif (typeof this.data === 'undefined' || this.data === null)\n\t\t{\n\t\t\tthrow new Error(`data is undefined`)\n\t\t}\n\n\t\tthis.data = sortPackageJson(this.data);\n\n\t\treturn this;\n\t}\n\n\twrite()\n\t{\n\t\tif (!this.file)\n\t\t{\n\t\t\tthrow new Error(`file is undefined`)\n\t\t}\n\n\t\tfs.writeJSONSync(this.file, this.json, {\n\t\t\tspaces: 2,\n\t\t});\n\n\t\treturn this;\n\t}\n\n\twriteWhenLoaded()\n\t{\n\t\tif (this.loaded)\n\t\t{\n\t\t\tthis.write();\n\t\t}\n\n\t\treturn this.loaded;\n\t}\n}\n\nexport declare module PackageJsonLoader\n{\n\n\n\texport type IPackageJson = ITSOverwrite<typeof PACKAGE_JSON, {\n\t\tscripts?: {\n\t\t\tprepublishOnly?: string,\n\t\t\ttest?: string,\n\t\t\tcoverage?: string,\n\t\t\tserve?: string,\n\t\t\tbuild?: string,\n\t\t\tdev?: string,\n\t\t\t[k: string]: string,\n\t\t},\n\t\tbin?: string | {\n\t\t\t[k: string]: string,\n\t\t},\n\t\tdirectories?: {\n\t\t\ttest?: string,\n\t\t\tbin?: string,\n\t\t\t[k: string]: string,\n\t\t},\n\t\tdependencies?: {\n\t\t\t[k: string]: string,\n\t\t},\n\t\tdevDependencies?: {\n\t\t\t[k: string]: string,\n\t\t},\n\t\tresolutions?: {\n\t\t\t[k: string]: string,\n\t\t},\n\t\tworkspaces?: any,\n\t}>;\n\n\t// @ts-ignore\n\texport { PackageJsonLoader }\n\t// @ts-ignore\n\texport { PackageJsonLoader as default }\n}\n\n// @ts-ignore\nexport import IPackageJson = PackageJsonLoader.IPackageJson;\nimport { ITSOverwrite } from 'ts-type';\n\n// @ts-ignore\nexport default PackageJsonLoader\n\n// @ts-ignore\nObject.assign(PackageJsonLoader, exports, {\n\tdefault: PackageJsonLoader,\n\tPackageJsonLoader,\n});\n\n// @ts-ignore\nObject.defineProperty(PackageJsonLoader, \"__esModule\", { value: true });\n\n// @ts-ignore\nexport = PackageJsonLoader\n"]}